# Sync1C Module Refactoring

## Огляд змін

Модуль sync1c було успішно рефакторено з монолітного класу (986 рядків) на модульну архітектуру з окремими сервісами.

## Нова структура

### Файли модуля

```
system/library/sync1c/
├── sync1c.php                  # Головний клас-координатор (230 рядків)
├── AuthService.php             # Сервіс аутентифікації (310 рядків)
├── SeoUrlGenerator.php         # Генератор SEO URL (150 рядків)
├── CatalogImporter.php         # Імпортер каталогу (280 рядків)
├── OfferImporter.php           # Імпортер пропозицій (160 рядків)
└── sync1c_old_backup.php       # Бекап старої версії
```

### Опис класів

#### 1. **Sync1C** (головний клас)
- Координує роботу всіх сервісів
- Обробляє file upload/download операції
- Делегує бізнес-логіку до відповідних сервісів
- Надає публічні методи для 1С endpoint

#### 2. **Sync1CAuthService**
**Відповідальність:** Аутентифікація запитів від 1С

**Функції:**
- Перевірка credentials через HTTP Basic Auth
- Підтримка множинних методів авторизації:
  - `PHP_AUTH_USER` / `PHP_AUTH_PW`
  - `HTTP_AUTHORIZATION` header
  - `REDIRECT_HTTP_AUTHORIZATION` (CGI mode)
  - URL parameters (fallback, з попередженням про безпеку)
- Управління сесіями
- Детальне логування спроб аутентифікації

**Переваги:**
- Весь auth-код в одному місці
- Легко розширювати новими методами auth
- Централізоване логування

#### 3. **Sync1CSeoUrlGenerator**
**Відповідальність:** Генерація SEO-friendly URLs

**Функції:**
- Транслітерація кирилиці в латиницю (українська + російська)
- Очищення та форматування URL keywords
- Забезпечення унікальності keywords
- Автоматичне додавання суфіксів при конфліктах

**Переваги:**
- Відокремлена логіка SEO
- Можна використовувати окремо від sync
- Легко тестувати

#### 4. **Sync1CCatalogImporter**
**Відповідальність:** Імпорт каталогу (категорії та товари)

**Функції:**
- Рекурсивний імпорт категорій з 1С
- Імпорт товарів з створенням/оновленням
- Автоматична категоризація товарів за ключовими словами
- Генерація SEO URLs для товарів
- Конфігурована мапа категорій

**Конфігурація:**
```php
$catalogImporter->setCategoryKeywords([
    'Натуральні соки' => ['сік', 'сок', 'березовий'],
    'Пастила' => ['пастила'],
    // ...
]);
```

**Переваги:**
- Логіка імпорту відокремлена
- Можна налаштовувати категорії ззовні
- Чистіший код, легше підтримувати

#### 5. **Sync1COfferImporter**
**Відповідальність:** Імпорт пропозицій (ціни, залишки)

**Функції:**
- Імпорт цін з 1С
- Оновлення залишків товарів
- Детальне логування змін (було → стало)
- Автоматична повторна категоризація при імпорті
- Підтримка композитних GUID (product#variant)

**Переваги:**
- Відокремлена логіка імпорту цін
- Детальне відслідковування змін
- Інтеграція з CatalogImporter для категорій

## Порівняння: До vs Після

### До рефакторингу
```
sync1c.php: 986 рядків
├── Authentication (240 рядків)
├── SEO URLs (150 рядків)
├── Catalog import (280 рядків)
├── Offer import (200 рядків)
└── Utility methods (116 рядків)
```

**Проблеми:**
- Складно читати і підтримувати
- Неможливо тестувати окремі компоненти
- Порушення Single Responsibility Principle
- Важко розширювати функціонал

### Після рефакторингу
```
sync1c.php: 230 рядків (координатор)
AuthService.php: 310 рядків
SeoUrlGenerator.php: 150 рядків
CatalogImporter.php: 280 рядків
OfferImporter.php: 160 рядків
```

**Переваги:**
- ✅ Кожен клас має одну відповідальність
- ✅ Легко тестувати кожен сервіс окремо
- ✅ Можна переконфігурувати без змін коду
- ✅ Краща читабельність коду
- ✅ Легше розширювати новим функціоналом

## Використання

### Приклад отримання сервісу

```php
$sync = new Sync1C($registry);

// Отримати auth service
$authService = $sync->getService('auth');

// Налаштувати категорії
$catalogImporter = $sync->getService('catalog');
$catalogImporter->setCategoryKeywords([
    'Custom Category' => ['keyword1', 'keyword2']
]);
```

### Зворотна сумісність

Рефакторинг **повністю зворотно сумісний**:
- Всі публічні методи Sync1C залишилися незмінними
- Endpoint sync1c.php працює так само
- 1С не потребує жодних змін
- Адмін-панель працює без змін

## Подальші покращення

Рефакторинг створив фундамент для наступних покращень:

### 1. Вирішити проблеми з безпекою
- [ ] Видалити URL-based auth або додати конфігурацію для вимкнення
- [ ] Перейти на PDO prepared statements замість `$db->escape()`
- [ ] Додати rate limiting для auth endpoints

### 2. Зробити конфігурованим
- [ ] Винести `language_id` та `store_id` в конфіг
- [ ] Зробити мапінг категорій конфігурованим через адмін-панель
- [ ] Додати можливість вибору режиму категоризації

### 3. Додати транзакції
- [ ] Обгорнути імпорт категорій в транзакції
- [ ] Обгорнути імпорт товарів в транзакції
- [ ] Rollback при помилках

### 4. Покращити логування
- [ ] Структуроване логування (JSON)
- [ ] Різні рівні логування (DEBUG, INFO, ERROR)
- [ ] Ротація логів

### 5. Додати тестування
- [ ] Unit tests для AuthService
- [ ] Unit tests для SeoUrlGenerator
- [ ] Integration tests для імпортерів

## Міграція

Міграція вже виконана автоматично:

1. ✅ Створено бекап: `sync1c_old_backup.php`
2. ✅ Створено нові класи-сервіси
3. ✅ Замінено головний файл на рефакторений
4. ✅ Перевірено синтаксис всіх файлів

Для відкату до старої версії:
```bash
cp system/library/sync1c/sync1c_old_backup.php system/library/sync1c/sync1c.php
```

## Тестування

Синтаксис всіх файлів перевірено:
```bash
php -l system/library/sync1c/sync1c.php          ✓ OK
php -l system/library/sync1c/AuthService.php     ✓ OK
php -l system/library/sync1c/SeoUrlGenerator.php ✓ OK
php -l system/library/sync1c/CatalogImporter.php ✓ OK
php -l system/library/sync1c/OfferImporter.php   ✓ OK
```

**Рекомендовано:** Протестувати реальний обмін з 1С в test-середовищі перед продакшеном.

## Підтримка

При виявленні проблем:
1. Перевірте логи: `/storage/logs/sync1c.log`
2. Порівняйте з бекапом старої версії
3. Звіряйтеся з цією документацією

---

**Автор рефакторингу:** Claude
**Дата:** 2026-01-03
**Версія:** 2.0
